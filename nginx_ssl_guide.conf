# =====================================
# Nginx SSL 完整配置指南
# =====================================

# 方案一：Let's Encrypt 免费证书（推荐）
# =====================================

# 1. 安装 certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 2. 申请证书（自动修改 nginx 配置）
sudo certbot --nginx -d meet.xxx.com

# 3. 测试自动续期
sudo certbot renew --dry-run

# 4. 手动续期（实际会自动运行）
sudo certbot renew

# =====================================
# 方案二：手动配置 SSL
# =====================================

server {
    listen 80;
    server_name meet.xxx.com;
    return 301 https://$server_name$request_uri;  # HTTP 强制跳转 HTTPS
}

server {
    listen 443 ssl http2;  # http2 加速
    server_name meet.xxx.com;

    # 证书路径（Let's Encrypt 默认路径）
    ssl_certificate /etc/letsencrypt/live/meet.xxx.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/meet.xxx.com/privkey.pem;

    # SSL 优化配置
    ssl_protocols TLSv1.2 TLSv1.3;  # 禁用不安全的 TLSv1.0/1.1
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # OCSP Stapling（加速 SSL 握手）
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/meet.xxx.com/chain.pem;
    resolver 8.8.8.8 114.114.114.114 valid=300s;
    resolver_timeout 5s;

    # HSTS（强制 HTTPS，防中间人攻击）
    add_header Strict-Transport-Security "max-age=63072000" always;

    # 日志
    access_log /var/log/nginx/meet.xxx.com.access.log;
    error_log /var/log/nginx/meet.xxx.com.error.log;

    # 前端
    location / {
        root /var/www/meet.xxx.com/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS 支持
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
}

# =====================================
# 方案三：阿里云/腾讯云免费证书
# =====================================

# 1. 在控制台申请免费 SSL 证书
# 2. 下载 Nginx 格式证书（两个文件：.crt 和 .key）
# 3. 上传到服务器

server {
    listen 443 ssl http2;
    server_name meet.xxx.com;

    # 云厂商证书路径
    ssl_certificate /etc/nginx/ssl/meet.xxx.com.crt;      # 证书文件
    ssl_certificate_key /etc/nginx/ssl/meet.xxx.com.key;  # 私钥文件

    # 其余配置同上...
}

# =====================================
# 方案四：自签名证书（本地测试用）
# =====================================

# 1. 生成自签名证书
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/nginx/ssl/meet.xxx.com.key \
    -out /etc/nginx/ssl/meet.xxx.com.crt \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=MyOrg/CN=meet.xxx.com"

# 2. 配置同方案二（但浏览器会报不安全警告）

# =====================================
# 自动续期定时任务（crontab）
# =====================================

# 编辑 crontab
sudo crontab -e

# 添加（每天 2:30 检查续期）
30 2 * * * /usr/bin/certbot renew --quiet --nginx

# 或者使用 systemd timer（certbot 已自动安装）
systemctl status certbot.timer
